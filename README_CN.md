# IOC-Golang：一款 GO 语言依赖注入框架

IOC-Golang 是一款强大的 Go 语言依赖注入框架，提供了一套完善的 IoC 容器。其能力如下：

- 依赖注入

  支持任何结构、接口的依赖注入。

- 完善的对象生命周期管理机制。

  可以接管对象的创建、参数注入、工厂方法。可定制化对象参数来源。

- 自动代码生成能力

  我们提供了代码生成工具，开发者可以通过注解的方式标注结构，从而便捷地生成结构注册代码。

- 代码调试能力

  基于 AOP 的思路，为由框架接管的对象方法提供运行时监控、调试能力。

- 可扩展能力

  支持自动装载模型的扩展、注入参数来源的扩展、对象方法 AOP 层的扩展。

- 完备的预制组件

  提供覆盖主流中间件的预制对象，方便直接注入使用。



## 项目列表

- **ioc-golang：**[ioc-golang](http://github.com/alibaba/IOC-Golang) 框架内核
    - 配置加载模块：负责解析用户yaml配置文件
    - 自动装载模块：提供单例模型、多例模型和扩展模型，负责依赖注入与对象方法 AOP 层封装。
    - 调试模块：提供调试 API、提供调试注入层实现。

- **ioc-golang-extension：**[ioc-golang-extension](http://github.com/alibaba/IOC-Golang/extension) 组件扩展仓库
    - 提供基于多种注入模型的预置实现结构：
        - Config：配置字段注入
        - Normal：多例模型
            - redis
            - mysql
        - singleton：单例模型
            - http-server
    - 待后续开源侧扩充

- **ioc-golang-example：**[ioc-golang-example](http://github.com/alibaba/IOC-Golang/example) 示例仓库
    - 配置注入
    - mysql client
    - grpc client
    - redis client
    - 使用调试能力
    - 通过 API 获取对象
    - 待后续扩充

- **ioc-go-cli：**[ioc-go-cli](http://github.com/alibaba/IOC-Golang/ioc-go-cli) 代码生成/程序调试 工具

  提供基于注解的结构描述信息自动生成能力

## 快速开始

### 安装代码生成工具

```shell
go install github.com/alibaba/IOC-Golang/ioc-go-cli@latest
```

### 依赖注入教程

我们将开发一个具有以下拓扑的工程，在本例子中，可以展示代码生成、接口注入、对象指针注入、API 获取对象能力。

![image-20220511193857200](http://gitlab.alibaba-inc.com/glory/doc/raw/master/image/image-20220511193857200.png)

用户所需编写的全部代码：main.go

```go
package main

import (
	"fmt"
	"github.com/alibaba/IOC-Golang"
	"github.com/alibaba/IOC-Golang/autowire/singleton"
)

// +ioc:autowire=true
// +ioc:autowire:type=singleton

type App struct {
	ServiceImpl1 Service `singleton:"ServiceImpl1"` // 要求注入Service 的 ServiceImpl1 实现
	ServiceImpl2 Service `singleton:"ServiceImpl2"` // 要求注入Service 的 ServiceImpl2 实现
	ServiceStruct *ServiceStruct `singleton:"ServiceStruct"` // 要求注入 ServiceStruct 指针
}

func (a*App) Run(){
	a.ServiceImpl1.Hello()
	a.ServiceImpl2.Hello()
	a.ServiceStruct.Hello()
}


type Service interface{
	Hello()
}

// +ioc:autowire=true
// +ioc:autowire:type=singleton
// +ioc:autowire:interface=Service

type ServiceImpl1 struct {

}

func (s *ServiceImpl1) Hello(){
	fmt.Println("This is ServiceImpl1, hello world")
}

// +ioc:autowire=true
// +ioc:autowire:type=singleton
// +ioc:autowire:interface=Service

type ServiceImpl2 struct {

}

func (s *ServiceImpl2) Hello(){
	fmt.Println("This is ServiceImpl2, hello world")
}

// +ioc:autowire=true
// +ioc:autowire:type=singleton

type ServiceStruct struct {

}

func (s *ServiceStruct) Hello(){
	fmt.Println("This is ServiceStruct, hello world")
}

func main(){
	// 框架启动
	if err := ioc.Load(); err != nil{
		panic(err)
	}

	// App-App 即结构ID： '$(接口名)-$(方法名)'， 对于结构指针，接口名默认为方法名
	// 可通过这一 ID 获取实例
	appInterface, err := singleton.GetImpl("App-App")
	if err != nil{
		panic(err)
	}
	app := appInterface.(*App)
	app.Run()
}
```

编写完毕后，当前目录命令行执行（mac 环境可能因为权限原因需要sudo）：

```bash
sudo ioc-go-cli gen
```

会在当前目录生成：zz_generated.ioc.go，开发者无需关心这一文件，该文件包含了所有接口的描述信息，

```go
//go:build !ignore_autogenerated
// +build !ignore_autogenerated

// Code generated by ioc-go-cli

package main

import (
	"github.com/alibaba/IOC-Golang/autowire"
	"github.com/alibaba/IOC-Golang/autowire/singleton"
)

func init() {
	singleton.RegisterStructDescriber(&autowire.StructDescriber{
		Interface: &App{},
		Factory: func() interface{} {
			return &App{}
		},
	})
	singleton.RegisterStructDescriber(&autowire.StructDescriber{
		Interface: new(Service),
		Factory: func() interface{} {
			return &ServiceImpl1{}
		},
	})
	singleton.RegisterStructDescriber(&autowire.StructDescriber{
		Interface: new(Service),
		Factory: func() interface{} {
			return &ServiceImpl2{}
		},
	})
	singleton.RegisterStructDescriber(&autowire.StructDescriber{
		Interface: &ServiceStruct{},
		Factory: func() interface{} {
			return &ServiceStruct{}
		},
	})
}

```

初始化 go mod

执行

```bash
% go mod tidy
% tree
.
├── go.mod
├── go.sum
├── main.go
└── zz_generated.ioc.go
```

执行程序：

`go run .`

控制台打印输出：

```sh
  ___    ___     ____            ____           _                         
 |_ _|  / _ \   / ___|          / ___|   ___   | |   __ _   _ __     __ _ 
  | |  | | | | | |      _____  | |  _   / _ \  | |  / _` | | '_ \   / _` |
  | |  | |_| | | |___  |_____| | |_| | | (_) | | | | (_| | | | | | | (_| |
 |___|  \___/   \____|          \____|  \___/  |_|  \__,_| |_| |_|  \__, |
                                                                    |___/ 
Welcome to use ioc-golang!
[Boot] Start to load ioc-golang config
[Config] Load config file from ../conf/ioc_golang.yaml
Load ioc_golang config file failed. open ../conf/ioc_golang.yaml: no such file or directory
 The load procedure is continue
[Boot] Start to load debug
[Debug] Debug mod is not enabled
[Boot] Start to load autowire
[Autowire Type] Found registered autowire type singleton
[Autowire Struct Descriptor] Found type singleton registered SD App-App
[Autowire Struct Descriptor] Found type singleton registered SD Service-ServiceImpl1
[Autowire Struct Descriptor] Found type singleton registered SD Service-ServiceImpl2
[Autowire Struct Descriptor] Found type singleton registered SD ServiceStruct-ServiceStruct
This is ServiceImpl1, hello world
This is ServiceImpl2, hello world
This is ServiceStruct, hello world
```

可看到，注入成功，程序正常运行。

### 注解分析

```go
// +ioc:autowire=true
代码生成工具会识别到标有 +ioc:autowire=true 注解的对象

// +ioc:autowire:type=singleton
标记注入模型为 singleton 单例模型，还有 normal 多例模型，config 配置模型，grpc grpc客户端模型等扩展。

// +ioc:autowire:interface=Service
标记实现了接口 Service，可被注入到 Service 类型的对象中。
```

###  更多

更多代码生成注解可以移步[ioc-golang-cli](http://github.com/alibaba/IOC-Golang/ioc-go-cli) 查看。

可以移步[ioc-golang-example.git](http://github.com/alibaba/IOC-Golang/example)  查看更多例子和高级使用方法。


### License

IOC-Golang developed by Alibaba and licensed under the Apache License (Version 2.0).
See the NOTICE file for more information.